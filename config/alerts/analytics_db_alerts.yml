# Analytics Database Alert Rules
# Version: 1.0.0
# Date: 2026-01-09
# Purpose: Alert rules for database performance monitoring in OSM-Notes-Analytics
#
# These alert rules are designed to work with Prometheus/Grafana alerting
# or can be adapted for use with the monitoring system's alert functions

groups:
  - name: analytics_db_alerts
    interval: 30s
    rules:
      # Slow Queries Alert
      - alert: AnalyticsSlowQueries
        expr: analytics_db_slow_queries_count > 5
        for: 5m
        labels:
          severity: warning
          component: analytics
          alert_type: query_performance
        annotations:
          summary: "High number of slow queries detected"
          description: "There are {{ $value }} slow queries (>30s) running in the Analytics database. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/QUERY_PERFORMANCE_OPTIMIZATION.md"

      # Cache Hit Ratio Low
      - alert: AnalyticsCacheHitRatioLow
        expr: analytics_db_cache_hit_ratio_percent < 90
        for: 10m
        labels:
          severity: warning
          component: analytics
          alert_type: database_performance
        annotations:
          summary: "Database cache hit ratio is low"
          description: "Cache hit ratio is {{ $value }}%, which is below the 90% threshold. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/QUERY_PERFORMANCE_OPTIMIZATION.md"

      # Cache Hit Ratio Critical
      - alert: AnalyticsCacheHitRatioCritical
        expr: analytics_db_cache_hit_ratio_percent < 80
        for: 5m
        labels:
          severity: critical
          component: analytics
          alert_type: database_performance
        annotations:
          summary: "Database cache hit ratio is critically low"
          description: "Cache hit ratio is {{ $value }}%, which is below the 80% critical threshold. Immediate action required. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/QUERY_PERFORMANCE_OPTIMIZATION.md"

      # High Active Connections
      - alert: AnalyticsHighConnections
        expr: analytics_db_total_connections > 80
        for: 5m
        labels:
          severity: warning
          component: analytics
          alert_type: database_connections
        annotations:
          summary: "High number of active database connections"
          description: "There are {{ $value }} active connections to the Analytics database, which exceeds the 80 connection threshold. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/PRODUCTION_TROUBLESHOOTING_GUIDE.md"

      # Connection Pool Exhaustion
      - alert: AnalyticsConnectionPoolExhaustion
        expr: analytics_db_total_connections > 90
        for: 2m
        labels:
          severity: critical
          component: analytics
          alert_type: database_connections
        annotations:
          summary: "Database connection pool near exhaustion"
          description: "There are {{ $value }} active connections, approaching the maximum pool size. Immediate action required. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/PRODUCTION_TROUBLESHOOTING_GUIDE.md"

      # Active Locks High
      - alert: AnalyticsHighActiveLocks
        expr: analytics_db_active_locks_count > 50
        for: 5m
        labels:
          severity: warning
          component: analytics
          alert_type: database_locks
        annotations:
          summary: "High number of active database locks"
          description: "There are {{ $value }} active locks in the Analytics database, which may indicate blocking queries. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/PRODUCTION_TROUBLESHOOTING_GUIDE.md"

      # Deadlocks Detected
      - alert: AnalyticsDeadlocksDetected
        expr: increase(analytics_db_deadlocks_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: analytics
          alert_type: database_deadlocks
        annotations:
          summary: "Database deadlocks detected"
          description: "Deadlocks have been detected in the Analytics database. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/PRODUCTION_TROUBLESHOOTING_GUIDE.md"

      # Table Bloat High
      - alert: AnalyticsTableBloatHigh
        expr: analytics_db_overall_bloat_percent > 20
        for: 10m
        labels:
          severity: warning
          component: analytics
          alert_type: database_maintenance
        annotations:
          summary: "High table bloat detected"
          description: "Overall table bloat is {{ $value }}%, which exceeds the 20% threshold. Consider running VACUUM. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/QUERY_PERFORMANCE_OPTIMIZATION.md"

      # Table Bloat Critical
      - alert: AnalyticsTableBloatCritical
        expr: analytics_db_overall_bloat_percent > 30
        for: 5m
        labels:
          severity: critical
          component: analytics
          alert_type: database_maintenance
        annotations:
          summary: "Critical table bloat detected"
          description: "Overall table bloat is {{ $value }}%, which exceeds the 30% critical threshold. Immediate VACUUM required. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/QUERY_PERFORMANCE_OPTIMIZATION.md"

      # DWH Schema Size High
      - alert: AnalyticsDWHSchemaSizeHigh
        expr: analytics_db_schema_size_bytes > 107374182400
        for: 10m
        labels:
          severity: warning
          component: analytics
          alert_type: storage
        annotations:
          summary: "DWH schema size is high"
          description: "DWH schema size is {{ $value | humanize1024 }}B, which exceeds the 100GB threshold. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/CAPACITY_PLANNING_GUIDE.md"

      # Facts Table Size High
      - alert: AnalyticsFactsTableSizeHigh
        expr: analytics_db_facts_total_size_bytes > 53687091200
        for: 10m
        labels:
          severity: warning
          component: analytics
          alert_type: storage
        annotations:
          summary: "Facts table size is high"
          description: "Facts table total size is {{ $value | humanize1024 }}B, which exceeds the 50GB threshold. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/CAPACITY_PLANNING_GUIDE.md"

      # Long Running Query
      - alert: AnalyticsLongRunningQuery
        expr: analytics_db_query_duration_seconds > 300
        for: 2m
        labels:
          severity: warning
          component: analytics
          alert_type: query_performance
        annotations:
          summary: "Long running query detected"
          description: "A query has been running for {{ $value }} seconds (>5 minutes). Component: {{ $labels.component }}, Query: {{ $labels.query_preview }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/QUERY_PERFORMANCE_OPTIMIZATION.md"

      # Blocking Queries
      - alert: AnalyticsBlockingQueries
        expr: analytics_db_blocking_queries_count > 0
        for: 1m
        labels:
          severity: warning
          component: analytics
          alert_type: database_locks
        annotations:
          summary: "Blocking queries detected"
          description: "There are {{ $value }} queries blocking other queries in the Analytics database. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes/OSM-Notes-Monitoring/blob/main/docs/PRODUCTION_TROUBLESHOOTING_GUIDE.md"

# Note: These alert rules use Prometheus query syntax
# For use with the monitoring system's alert functions, adapt the expressions
# to match the metric names and formats used by record_metric() calls
#
# Example adaptation for shell-based alerting:
#   if [[ "${db_cache_hit_ratio_percent}" -lt 90 ]]; then
#     send_alert "ANALYTICS" "warning" "database_performance" "Cache hit ratio is ${db_cache_hit_ratio_percent}%"
#   fi
