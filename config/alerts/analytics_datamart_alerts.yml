# Analytics Datamart Alert Rules
# Version: 1.0.0
# Date: 2026-01-09
# Purpose: Alert rules for datamart monitoring in OSM-Notes-Analytics
#
# These alert rules are designed to work with Prometheus/Grafana alerting
# or can be adapted for use with the monitoring system's alert functions

groups:
  - name: analytics_datamart_alerts
    interval: 30s
    rules:
      # Obsolete Datamart Alert
      - alert: AnalyticsDatamartObsolete
        expr: analytics_datamart_freshness_seconds > 86400
        for: 10m
        labels:
          severity: warning
          component: analytics
          alert_type: datamart_freshness
        annotations:
          summary: "Datamart is obsolete (not updated in >24 hours)"
          description: "Datamart {{ $labels.datamart }} has not been updated in {{ $value | humanizeDuration }}. Last update was more than 24 hours ago. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

      # Critical Obsolete Datamart Alert
      - alert: AnalyticsDatamartCriticallyObsolete
        expr: analytics_datamart_freshness_seconds > 172800
        for: 5m
        labels:
          severity: critical
          component: analytics
          alert_type: datamart_freshness
        annotations:
          summary: "Datamart is critically obsolete (not updated in >48 hours)"
          description: "Datamart {{ $labels.datamart }} has not been updated in {{ $value | humanizeDuration }}. Last update was more than 48 hours ago. Immediate action required. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

      # Datamart Process Not Running
      - alert: AnalyticsDatamartNotRunning
        expr: analytics_datamart_process_running == 0
        for: 5m
        labels:
          severity: warning
          component: analytics
          alert_type: datamart_process
        annotations:
          summary: "Datamart process is not running"
          description: "Datamart {{ $labels.datamart }} process is not running. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

      # Datamart Execution Failed
      - alert: AnalyticsDatamartExecutionFailed
        expr: increase(analytics_datamart_execution_count_total[5m]) > increase(analytics_datamart_success_count_total[5m])
        for: 5m
        labels:
          severity: warning
          component: analytics
          alert_type: datamart_execution
        annotations:
          summary: "Datamart execution failures detected"
          description: "Datamart {{ $labels.datamart }} has execution failures. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

      # Low Datamart Success Rate
      - alert: AnalyticsDatamartLowSuccessRate
        expr: analytics_datamart_success_rate_percent < 80
        for: 10m
        labels:
          severity: warning
          component: analytics
          alert_type: datamart_execution
        annotations:
          summary: "Datamart success rate is low"
          description: "Datamart {{ $labels.datamart }} success rate is {{ $value }}%, which is below the 80% threshold. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

      # Long Datamart Execution Duration
      - alert: AnalyticsDatamartLongExecution
        expr: analytics_datamart_execution_duration_seconds > 3600
        for: 5m
        labels:
          severity: warning
          component: analytics
          alert_type: datamart_performance
        annotations:
          summary: "Datamart execution is taking too long"
          description: "Datamart {{ $labels.datamart }} execution duration is {{ $value | humanizeDuration }}, which exceeds the 1 hour threshold. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

      # Datamart Update Gap Detected
      - alert: AnalyticsDatamartUpdateGap
        expr: analytics_datamart_freshness_seconds > 90000
        for: 5m
        labels:
          severity: warning
          component: analytics
          alert_type: datamart_freshness
        annotations:
          summary: "Datamart update gap detected"
          description: "Datamart {{ $labels.datamart }} has a gap in updates. Last update was {{ $value | humanizeDuration }} ago (>25 hours). Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

      # Datamart Records Decreasing
      - alert: AnalyticsDatamartRecordsDecreasing
        expr: delta(analytics_datamart_records_total[1h]) < 0
        for: 5m
        labels:
          severity: warning
          component: analytics
          alert_type: datamart_data
        annotations:
          summary: "Datamart records are decreasing"
          description: "Datamart {{ $labels.datamart }} record count decreased by {{ $value | abs }} in the last hour. This may indicate data loss. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

      # Datamart Countries Processing Stalled
      - alert: AnalyticsDatamartCountriesStalled
        expr: analytics_datamart_countries_processed_total == 0
        for: 10m
        labels:
          severity: warning
          component: analytics
          alert_type: datamart_processing
        annotations:
          summary: "DatamartCountries processing appears stalled"
          description: "DatamartCountries has processed 0 countries in the last 10 minutes. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

      # Datamart Users Initial Load Stalled
      - alert: AnalyticsDatamartUsersLoadStalled
        expr: analytics_datamart_initial_load_progress_percent == 0
        for: 30m
        labels:
          severity: warning
          component: analytics
          alert_type: datamart_processing
        annotations:
          summary: "DatamartUsers initial load appears stalled"
          description: "DatamartUsers initial load progress is 0% for 30 minutes. Component: {{ $labels.component }}"
          runbook_url: "https://github.com/OSM-Notes-Monitoring/docs/ANALYTICS_MONITORING_GUIDE.md"

# Note: These alert rules use Prometheus query syntax
# For use with the monitoring system's alert functions, adapt the expressions
# to match the metric names and formats used by record_metric() calls
#
# Example adaptation for shell-based alerting:
#   if [[ "${datamart_freshness_seconds}" -gt 86400 ]]; then
#     send_alert "ANALYTICS" "warning" "datamart_freshness" "Datamart ${datamart_name} is obsolete (>24h)"
#   fi
